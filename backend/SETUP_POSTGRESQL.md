# Настройка Managed PostgreSQL для продакшена

## Шаг 1: Создание кластера PostgreSQL

### Через веб-консоль:

1. Перейдите в [Managed Service for PostgreSQL](https://console.cloud.yandex.ru/folders)
2. Нажмите **"Создать кластер"**
3. Заполните параметры:

   **Основные параметры:**
   - **Имя кластера:** `happyrussia-db`
   - **Окружение:** `Production` (или `Testing` для тестов)
   - **Версия PostgreSQL:** `15` (или последняя доступная)
   - **Класс хоста:** `s2.micro` (1 vCPU, 4 GB RAM) - минимальный для начала
   - **Размер диска:** `10 GB` (можно увеличить позже)
   - **Тип диска:** `SSD`

   **База данных:**
   - **Имя БД:** `happyrussia`
   - **Имя пользователя:** `happyrussia_user`
   - **Пароль:** Сгенерируйте надежный пароль (сохраните его!)

   **Сеть:**
   - Выберите вашу сеть или создайте новую
   - **Публичный доступ:** Включите (для доступа из контейнера)

   **Хосты:**
   - Оставьте настройки по умолчанию

4. Нажмите **"Создать кластер"**

### Ожидание создания

Создание кластера займет 5-10 минут. Дождитесь статуса **"Running"**.

## Шаг 2: Получение данных подключения

После создания кластера:

1. Откройте кластер `happyrussia-db`
2. Перейдите на вкладку **"Подключение"**
3. Скопируйте:
   - **FQDN хоста** (например: `c-xxxxx.rw.mdb.yandexcloud.net`)
   - **Порт:** `6432` (обычно для Managed PostgreSQL)
   - **Имя БД:** `happyrussia`
   - **Имя пользователя:** `happyrussia_user`
   - **Пароль:** (который вы создали)

## Шаг 3: Формат строки подключения

Строка подключения будет выглядеть так:

```
postgresql://happyrussia_user:ВАШ_ПАРОЛЬ@c-xxxxx.rw.mdb.yandexcloud.net:6432/happyrussia
```

## Шаг 4: Настройка безопасности

### Добавьте IP-адреса для доступа:

1. В кластере перейдите на вкладку **"Безопасность"**
2. Добавьте правило:
   - **Источник:** `0.0.0.0/0` (для доступа из контейнера) или конкретный IP
   - **Тип:** `CIDR`

### Или используйте SSL:

Для безопасного подключения используйте SSL. Yandex Cloud предоставляет сертификат.

## Шаг 5: Настройка переменных окружения в контейнере

После создания кластера нужно обновить ревизию контейнера:

1. Откройте контейнер `happyrussia-api`
2. Создайте новую ревизию
3. В разделе **"Переменные окружения"** добавьте:

   ```
   DATABASE_URL=postgresql://happyrussia_user:ВАШ_ПАРОЛЬ@c-xxxxx.rw.mdb.yandexcloud.net:6432/happyrussia
   ```

   **Важно:** Замените `ВАШ_ПАРОЛЬ` и `c-xxxxx.rw.mdb.yandexcloud.net` на реальные значения.

4. Сохраните и создайте ревизию

## Шаг 6: Проверка подключения

После обновления контейнера проверьте логи:

1. Откройте контейнер
2. Перейдите на вкладку **"Логи"**
3. Убедитесь, что нет ошибок подключения к БД

## Альтернатива: Использование секретов

Для безопасности паролей можно использовать Yandex Lockbox:

1. Создайте секрет в Lockbox с паролем БД
2. Назначьте сервисному аккаунту роль `lockbox.payloadViewer`
3. В контейнере используйте переменную окружения с ссылкой на секрет

## Стоимость

Managed PostgreSQL в Yandex Cloud:
- Минимальная конфигурация (s2.micro, 10 GB): ~1500-2000 руб/мес
- Можно использовать для тестирования, затем масштабировать

## Миграция данных

Если у вас уже есть данные в SQLite:
1. Экспортируйте данные из SQLite
2. Импортируйте в PostgreSQL
3. Или начните с пустой БД (данные появятся при использовании приложения)

